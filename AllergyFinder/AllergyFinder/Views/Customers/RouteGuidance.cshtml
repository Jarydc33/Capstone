@model AllergyFinder.Models.RouteGuidanceViewModel
@{
    ViewBag.Title = "RouteGuidance";
}

<div class="HomeHeader">
    <h3>Route Guidance</h3>
</div>

<div class="row">
    <div class="col-md-2">
        @Html.Partial("_SideBarPartial")
    </div>
    <div class="col-md-8">
        <div id="map"></div>
    </div>
</div>

<script>

    var latitude = @Html.Raw(Json.Encode(Model.coordinates[0]));
    var longitude = @Html.Raw(Json.Encode(Model.coordinates[1]));
    var pos;

    function initMap() {
        var pointA = new google.maps.LatLng(43.0389, -87.9065),
            pointB = new google.maps.LatLng(latitude, longitude),
            myOptions = {
                zoom: 7,
                center: pointA
            },
            map = new google.maps.Map(document.getElementById('map'), myOptions),
            // Instantiate a directions service.
            directionsService = new google.maps.DirectionsService,
            directionsDisplay = new google.maps.DirectionsRenderer({
                map: map
            }),
            //markerA = new google.maps.Marker({
            //    position: pointA,
            //    title: "point A",
            //    label: "A",
            //    map: map
            //}),
            //markerB = new google.maps.Marker({
            //    position: pointB,
            //    title: "point B",
            //    label: "B",
            //    map: map
            //});

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                infoWindow.setPosition(pos);
                infoWindow.setContent('Location found.');
                infoWindow.open(map);
                map.setCenter(pos);
            }, function () {
                handleLocationError(true, infoWindow, map.getCenter());
            });
        } else {
            handleLocationError(false, infoWindow, map.getCenter());
        }

        calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB);

    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
            'Error: The Geolocation service failed.' :
            'Error: Your browser doesn\`t support geolcoation.');
        infoWindow.open(map);
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB) {
        directionsService.route({
            origin: pointA,
            destination: pointB,
            travelMode: google.maps.TravelMode.DRIVING
        }, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }

    initMap();
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=@Keys.GoogleKey&callback=initMap"
        async defer></script>